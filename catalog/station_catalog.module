<?php
// $Id$

define('STATION_CATALOG_CVS_ID', '$Id$');

if (module_exists('views')) {
  require_once(drupal_get_path('module', 'station_catalog') .'/views.inc');
#  require_once(drupal_get_path('module', 'station_catalog') .'/views_defaults.inc');
}

/**
 * Implementation of hook_help().
 */
function station_catalog_help($section='') {
  switch ($section) {
    case 'admin/settings/station/catalog':
      return t("These settings allow you to configure the station catalog.");
  }
}

/**
 * Implementation of hook_menu().
 */
function station_catalog_menu($may_cache) {
  if ($may_cache) {
    $items[] = array(
      'path' => 'admin/settings/station/catalog',
      'title' => t('Catalog'),
      'callback' => 'drupal_get_form',
      'callback arguments' => 'station_catalog_admin_settings',
      'access' => user_access('administer site configuration'),
      'type' => MENU_LOCAL_TASK
    );

    $items[] = array(
      'path' => 'station/catalog/search',
      'title' => t('Catalog'),
      'callback' => 'station_catalog_search_page',
      'access' => user_access('view catalog'),
      'type' => MENU_NORMAL_ITEM,
    );
  }

  return $items;
}


function station_catalog_admin_settings() {
  $form['station_category_redirect_on_add'] = array(
    '#type' => 'checkbox',
    '#title' => t('Add multiple albums'),
    '#default_value' => variable_get('station_category_redirect_on_add', TRUE),
    '#description' => t('If this is checked after adding a new album you will be redirected back to the new album form. This is much more convienient when entering multiple albums.'),
  );
  $form['module_cvs_id'] = array(
    '#type' => 'item',
    '#value' => '<pre>'. STATION_CATALOG_CVS_ID .'</pre>',
  );

  return system_settings_form($form);
}


/**
 * Implementation of hook_node_info().
 */
function station_catalog_node_info() {
  return array(
    'station_album' => array(
      'name' => t('Album'),
      'module' => 'station_catalog_album',
      'description' => t("An album in the station's library."),
      'has_title' => FALSE,
      'has_body' => TRUE,
      'body_label' => t('Description'),
    )
  );
}

/**
 * Implementation of hook_perm().
 */
function station_catalog_perm() {
  return array(
    'view catalog',
    'create album content',
    'edit album content',
    'administer catalog',
  );
}

/**
 * Implementation of hook_access().
 */
function station_catalog_album_access($op, $node) {
  global $user;

  // Admins can do anything.
  if (user_access('administer catalog')) {
    return TRUE;
  }
  
  switch ($op) {
    case 'view':
      return user_access('view catalog');

    case 'create':
      return user_access('create album content');

    case 'update':
    case 'delete':
      return user_access('edit album content');
  }
}

/**
 * Returns the the next unused album number.
 * 
 * @return
 *   Integer with the next, unused album number. 
 */
function station_catalog_album_next_number() {
  return db_result(db_query('SELECT MAX(number) + 1 FROM {station_catalog}'));
}

/**
 * Implementation of hook_prepare().
 */
function station_catalog_album_prepare(&$node) {
  if (isset($node->album['artist']) && isset($node->album['album'])) {
    if ($mb_info = _station_catalog_musicbrainz_album($node->album['artist'], $node->album['album'])) {
      $fields = array(
        'artist' => t('Artist'),
        'album' => t('Album'),
        'year' => t('Year'),
        'mb_release_id' => t('Music Brainz ID'),
        'asin' => t('ASIN'),
      );
      $adjusted = array();
      foreach ($fields as $field => $name) {
        if (empty($node->album[$field])) {
          $adjusted[] = $name;
          $node->album[$field] = $mb_info[$field];
        }
      }
      if ($adjusted) {
        drupal_set_message(t('Values for @fields fields were loaded from the MusicBrainz data.', array('@fields' => station_anded_list($adjusted))));
      }
    }
  }
}

/**
 * Implementation of hook_form().
 */
function station_catalog_album_form($node) {
  // Make it a little easier when doing data entry and redirect back to the
  // add form after submitting a new album.
  if (empty($node->nid) && variable_get('station_category_redirect_on_add', TRUE)) {
    $form['#redirect'] = 'node/add/station-album';
  }

  $form['album'] = array(
    '#type' => 'fieldset',
    '#title' => t('Album information'),
    '#tree' => TRUE,
    '#weight' => -4,
  );
  $form['album']['number'] = array(
    '#type' => 'textfield',
    '#title' => t('Number'),
    '#default_value' => isset($node->album['number']) ? $node->album['number'] : station_catalog_album_next_number(),
    '#required' => TRUE,
    '#description' => t("The album's log number must be numeric and unique."),
  );
  $form['album']['artist'] = array(
    '#type' => 'textfield',
    '#title' => t('Artist'),
    '#default_value' => $node->album['artist'],
    '#required' => TRUE,
    '#maxlength' => 255,
  );
  $form['album']['album'] = array(
    '#type' => 'textfield',
    '#title' => t('Album title'),
    '#default_value' => $node->album['album'],
    '#required' => TRUE,
    '#maxlength' => 255,
  );
  $form['album']['year'] = array(
    '#type' => 'textfield',
    '#title' => t('Year'),
    '#default_value' => $node->album['year'],
    '#required' => TRUE,
    '#description' => t("The year the album was released."),
  );
  $form['album']['label'] = array(
    '#type' => 'textfield',
    '#title' => t('Label'),
    '#default_value' => $node->album['label'],
    '#required' => FALSE,
    '#maxlength' => 255,
    '#description' => t("The year the album was released."),
  );
  $form['album']['mb_release_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Music Brainz Release ID'),
    '#default_value' => $node->album['mb_release_id'],
    '#required' => FALSE,
    '#maxlength' => 255,
    '#description' => t("MusicBrainz ID for this release."),
  );
  $form['album']['asin'] = array(
    '#type' => 'textfield',
    '#title' => t('Amazon Standard Identification Number'),
    '#default_value' => $node->album['asin'],
    '#required' => FALSE,
    '#maxlength' => 255,
    '#description' => t("Amazon product ID for this album."),
  );

  if ($type->has_body) {
    $form['body_filter']['body'] = array(
      '#type' => 'textarea',
      '#title' => check_plain($type->body_label),
      '#default_value' => $node->body,
      '#rows' => 10,
      '#required' => ($type->min_word_count > 0),
    );
    $form['body_filter']['format'] = filter_form($node->format);
  }

  return $form;
}

/**
 * Implementation of hook_validate().
 */
function station_catalog_album_validate(&$node, &$form) {
  if (!is_numeric($node->album['number'])) {
    form_set_error('number', t('Album number must be a numeric value.')));
  }
  else if ($node->album['number']) {
    // look for duplicate numbers
    if ($node->nid) {
      $query = db_query('SELECT sc.nid, n.title FROM {station_catalog} sc INNER JOIN {node} n ON sc.nid = n.nid WHERE sc.number = %d AND sc.nid <> %d', $node->album['number'], $node->nid);
    }
    else {
      $query = db_query('SELECT sc.nid, n.title FROM {station_catalog} sc INNER JOIN {node} n ON sc.nid = n.nid WHERE sc.number = %d', $node->album['number']);
    }
    if ($other_node = db_fetch_object($query)) {
      form_set_error(
        'number',
        t('Another album <a href="@link">%title</a> already has this number.', array('@link' => url('node/'. $other_node->nid), '%title' => $other_node->title))
      );
    }
  }

  if (!empty($node->album['year']) && !is_numeric($node->album['year'])) {
    form_set_error('year', t('Year must be a numeric value and %value is not.', array('%value' => ($node->album['year']))));
  }

  // Compute the title.
  $node->title = $node->album['artist'] .' - '. $node->album['album'];
  form_set_value($form['title'], $node->title);
}

/**
 * Implementation of hook_load().
 */
function station_catalog_album_load($node) {
  $result = db_query('SELECT number, artist, album, year, label, mb_release_id, asin FROM {station_catalog} WHERE nid = %d', $node->nid);
  return array('album' => db_fetch_array($result)); 
}

/**
 * Implementation of hook_insert().
 */
function station_catalog_album_insert($node) {
  db_query("INSERT INTO {station_catalog} (nid, number, artist, album, year, label, mb_release_id, asin) VALUES (%d, %d, '%s', '%s', %d, '%s', '%s', '%s')", $node->nid, $node->album['number'], $node->album['artist'], $node->album['album'], $node->album['year'], $node->album['label'], $node->album['mb_release_id'], $node->album['asin']);
}

/**
 * Implementation of hook_delete().
 */
function station_catalog_album_delete($node) {
  db_query("DELETE FROM {station_catalog} WHERE nid = %d", $node->nid);
}

/**
 * Implementation of hook_update().
 */
function station_catalog_album_update($node) {
  db_query("DELETE FROM {station_catalog} WHERE nid = %d", $node->nid);
  db_query("INSERT INTO {station_catalog} (nid, number, artist, album, year, label, mb_release_id, asin) VALUES (%d, %d, '%s', '%s', %d, '%s', '%s', '%s')", $node->nid, $node->album['number'], $node->album['artist'], $node->album['album'], $node->album['year'], $node->album['label'], $node->album['mb_release_id'], $node->album['asin']);
}

/**
 * Implementation of hook_view().
 */
function station_catalog_album_view(&$node, $teaser = FALSE, $page = FALSE) {
  $node = node_prepare($node, $teaser);

  if ($page) {
    $breadcrumb = array();
    $breadcrumb[] = array('path' => 'station/catalog', 'title' => t('Catalog'));
    $breadcrumb[] = array('path' => 'node/'. $node->nid);
    menu_set_location($breadcrumb);
  }

  $node->content['album'] = array(
    'number' => array(
      '#type' => 'item',
      '#title' => t('Number'),
      '#value' => $node->album['number'],
      '#weight' => -6,
    ),
    'artist' => array(
      '#type' => 'item',
      '#title' => t('Artist'),
      '#value' => $node->album['artist'],
      '#weight' => -5,
    ),
    'album' => array(
      '#type' => 'item',
      '#title' => t('Album'),
      '#value' => $node->album['album'],
      '#weight' => -4,
    ),
    'year' => array(
      '#type' => 'item',
      '#title' => t('Year'),
      '#value' => $node->album['year'] ? $node->album['year'] : '',
      '#weight' => -3,
    ),
    'label' => array(
      '#type' => 'item',
      '#title' => t('Label'),
      '#value' => $node->album['label'],
      '#weight' => -2,
    ),
  );

  if (!empty($node->album['mb_release_id'])) {
    $node->content['album']['mb_release_id'] = array(
      '#type' => 'item',
      '#title' => t('MusicBrainz'),
      '#value' => l($node->album['mb_release_id'], "http://musicbrainz.org/release/{$node->album['mb_release_id']}.html"),
      '#weight' => 0,
    );
  }
  if (!empty($node->album['asin'])) {
    $node->content['album']['asin'] = array(
      '#type' => 'item',
      '#title' => t('Amazon'),
      '#value' => l($node->album['asin'], 'http://www.amazon.com/gp/product/'. $node->album['asin']),
      '#weight' => 0,
    );
  }

  return $node;
}

/**
 * Implementation of hook_taxonomy().
 * 
 * Delete our vocabulary variable if the vocabulary is deleted.
 */
function station_catalog_taxonomy($op, $type, $object = NULL) {
  if ($op == 'delete' && $type == 'vocabulary' && $object->vid == _station_catalog_get_vid())  {
    variable_del('station_category_vocabulary');
  }
}


/**
 * Find or create a station catalog vocabulary ID.
 *
 * @return
 *   Vocabulary ID.
 */
function _station_catalog_get_vid() {
  $vid = variable_get('station_category_vocabulary', '');
  if (empty($vid)) {
    // Check to see if a a  vocabulary exists
    $vid = db_result(db_query("SELECT vid FROM {vocabulary} WHERE module = '%s'", 'station_catalog'));
    if (!$vid) {
      $vocabulary = array(
        'name' => t('Station album genres'),
        'description' => t("Select the appropriate genre's for this album."),
        'multiple' => '1', 
        'required' => '1', 
        'hierarchy' => '0', 
        'relations' => '0', 
        'module' => 'station_catalog', 
        'nodes' => array('station_album' => 1),
      );
      taxonomy_save_vocabulary($vocabulary);
      $vid = $vocabulary['vid'];
    }
    variable_set('station_category_vocabulary', $vid);
  }
  return $vid;
}

function station_catalog_search_page($field = '', $value ='') {
  $perpage = 30;

  $header = array(
    'number' => array('data' => t('Number'), 'field' => 'sc.number'),
    'artist' => array('data' => t('Artist'), 'field' => 'sc.artist'),
    'album' => array('data' => t('Album'), 'field' => 'sc.album'),
    'year' => array('data' => t('Year'), 'field' => 'sc.year'),
    'label' => array('data' => t('Label'), 'field' => 'sc.label'),
  );

  // Only search when there's a value and the field is valid.
  if (!empty($value) && in_array($field, array('number', 'artist', 'album', 'year', 'label'), TRUE)) {
    $header[$field]['sort'] = 'asc';
    $result = pager_query(db_rewrite_sql("SELECT n.nid, sc.* FROM {node} n INNER JOIN {station_catalog} sc ON n.nid = sc.nid WHERE LOWER(sc.$field) LIKE LOWER('%%%s%%')"). tablesort_sql($header), $perpage, 0, NULL, $value);
  }
  else {
    $header['number']['sort'] = 'desc';
    $result = pager_query(db_rewrite_sql("SELECT n.nid, sc.* FROM {node} n INNER JOIN {station_catalog} sc ON n.nid = sc.nid"). tablesort_sql($header), $perpage, 0);
  }

  $rows = array();
  while ($item = db_fetch_object($result)) {
    $link = 'node/'. $item->nid;
    $rows[] = array(
      array('data' => l($item->number, $link)),
      array('data' => l($item->artist, $link)),
      array('data' => l($item->album, $link)),
      array('data' => $item->year ? $item->year : ''),
      array('data' => $item->label)
    );
  }
  
  if (!$rows) {
    $rows[] = array(array('colspan' => 4, 'data' => t('No matches were found.')));
  }

  $output .= '<div id="station-catalog-search">';
  $output = drupal_get_form('station_catalog_search_form', $field, $value);
  $output .= '<div id="station-catalog-search-results">';
  $output .= theme('pager', array(), $perpage);
  $output .= theme('table', $header, $rows);
  $output .= theme('pager', array(), $perpage);
  $output .= '</div></div>';
  return $output;
}

function station_catalog_search_form($field = '', $value ='') {
  $form['search'] = array(
    '#type' => 'fieldset',
    '#title' => t('Search options'),
    '#prefix' => '<div class="container-inline">',
    '#suffix' => '</div>',
  );
  $form['search']['field'] = array(
    '#type' => 'select',
    '#title' => t('Field'),
    '#options' => array(
      'artist' => t('Artist'), 
      'album' => t('Album'), 
      'label' => t('Label'),
      'number' => t('Number'),
      'year' => t('Year'),
    ),
    '#default_value' => $field,
  );
  $form['search']['value'] = array(
    '#type' => 'textfield',
    '#title' => t('Value'),
    '#default_value' => $value,
    '#size' => 25,
    '#required' => TRUE,
  );
  $form['search']['filter'] = array(
    '#type' => 'submit', 
    '#value' => t('Filter'),
  );
  if (!empty($value)) {
    $form['search']['reset'] = array(
      '#type' => 'submit',
      '#value' => t('Reset'),
    );
  }
  return $form;
}

function station_catalog_search_form_submit($form_id, $form_values) {
  switch ($form_values['op']) {
    case t('Reset'):
      return 'station/catalog/search/'; 

    case t('Filter'):
      // Make sure it's an allowed search field.
      if (in_array($form_values['field'], array('number', 'artist', 'album', 'year', 'label'))) {
        return 'station/catalog/search/'. $form_values['field'] .'/'. $form_values['value'];
      }
  }
}

function _station_catalog_musicbrainz_album($artist, $title) {
  $args = array(
    'type' => 'xml',
    'artist' => $artist,
    'title' => $title
  );
  $url = url('http://musicbrainz.org/ws/1/release/', drupal_query_string_encode($args));

  $ret = array();

  $response = drupal_http_request($url);
  if ($response->code == 200) {
    $doc = DOMDocument::loadXML($response->data);

    $xpath = new DOMXPath($doc);
    // Can't use the default namespace, must explicitly set one...
    $xpath->registerNameSpace('mb', 'http://musicbrainz.org/ns/mmd-1.0#');
#dvm($doc->saveXML());
    // Only return exact matches.
    $result = $xpath->query('//mb:release-list/mb:release[@ext:score="100"]');
    if ($result && $result->length) {
      foreach ($result as $item) {
        $release = simplexml_import_dom($result->item(0));
#        dvm($release);
      }
      $release = simplexml_import_dom($result->item(0));
      $ret['mb_release_id'] = (string) $release['id'];
      $ret['artist'] = (string) $release->artist->name;
      $ret['album'] = (string) $release->title;
      $ret['asin'] = (string) $release->asin;
      // Release year is a bit of a pain, the tag name isn't a valid PHP 
      // identifier and we need to use a regular expression to match the 
      // year portion of the ate.
      $event = 'release-event-list';
      preg_match('/.*US (\d{4}).*/', $release->$event->event['date'], $matches);
      $ret['year'] = (string) $matches[1];

      // Now that we've got the release id, we need to make another call to get the label.
#      $label = _station_catalog_musicbrainz_label($ret['mb_release_id']);
      $ret['label'] = '';
    }
  }
  return $ret;
}

function _station_catalog_musicbrainz_label($release_id) {
  $args = array(
    'type' => 'xml',
    'inc' => 'labels',
  );
  $url = url('http://musicbrainz.org/ws/1/release/'. $release_id, drupal_query_string_encode($args));
dvm($url);
  $ret = array();
  $response = drupal_http_request($url);
  if ($response->code == 200) {
    $doc = DOMDocument::loadXML($response->data);
dvm($doc->savexml());
  }
  return $ret;
}
